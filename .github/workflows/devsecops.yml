name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
    # =========================
    # 1. Checkout
    # =========================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =========================
    # 2. Setup Node
    # =========================
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: 20
    cache: 'npm'
    cache-dependency-path: |
      backend/users-service/package-lock.json
      backend/academic-service/package-lock.json
      backend/api-gateway/package-lock.json
      frontend/package-lock.json

    # =========================
    # 3. Create .env (CI safe)
    # =========================
    - name: Create env files
      run: |
        touch backend/users-service/.env
        touch backend/academic-service/.env
        touch backend/api-gateway/.env
        touch frontend/.env

        echo "USERS_SERVICE_URL=http://users-service:3001" >> backend/api-gateway/.env
        echo "ACADEMIC_SERVICE_URL=http://academic-service:3002" >> backend/api-gateway/.env
        echo "VITE_API_URL=http://api-gateway:3000" >> frontend/.env

    # =========================
    # 4. Backend Lint + Test
    # =========================
    - name: Lint & Test users-service
      run: |
        cd backend/users-service
        npm ci
        npm run lint --if-present
        npm test

    - name: Lint & Test academic-service
      run: |
        cd backend/academic-service
        npm ci
        npm run lint --if-present
        npm test

    - name: Lint & Test api-gateway
      run: |
        cd backend/api-gateway
        npm ci
        npm run lint --if-present
        npm test

    # =========================
    # 5. Frontend Lint + Test
    # =========================
    - name: Lint & Test frontend
      run: |
        cd frontend
        npm ci
        npm run lint
        npm test

    # =========================
    # 6. SAST – Semgrep
    # =========================
    - name: Install Semgrep
      run: |
        python3 -m pip install --upgrade pip
        pip install semgrep

    - name: Run Semgrep
      run: semgrep --config=auto --severity=ERROR

    # =========================
    # 7. Docker Build
    # =========================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker images
      run: docker compose -f backend/docker-compose.yml build

    # =========================
    # 8. SCA – Trivy
    # =========================
    - name: Trivy scan users-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: users-service
        severity: CRITICAL
        ignore-unfixed: true
        exit-code: 1

    - name: Trivy scan academic-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: academic-service
        severity: CRITICAL
        ignore-unfixed: true
        exit-code: 1

    - name: Trivy scan api-gateway
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: api-gateway
        severity: CRITICAL
        ignore-unfixed: true
        exit-code: 1

    # =========================
    # 9. Smoke Test
    # =========================
    - name: Run docker-compose
      run: |
        docker compose -f backend/docker-compose.yml up -d
        sleep 20

    - name: Smoke test API Gateway
      run: curl --fail http://localhost:3000/health

    - name: Shutdown services
      if: always()
      run: docker compose -f backend/docker-compose.yml down